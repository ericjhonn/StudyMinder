<UserControl x:Class="StudyMinder.Views.ViewEstudoEditar"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:icon="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:viewmodels="clr-namespace:StudyMinder.ViewModels"
             xmlns:models="clr-namespace:StudyMinder.Models"
             xmlns:converters="clr-namespace:StudyMinder.Converters"
             xmlns:behaviors="clr-namespace:StudyMinder.Behaviors"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             mc:Ignorable="d"
             d:DesignHeight="600"
             d:DesignWidth="800"
             d:DataContext="{d:DesignInstance Type=viewmodels:EditarEstudoViewModel}">

    <UserControl.Resources>
        <converters:StringToBooleanConverter x:Key="StringToBooleanConverter" />
    </UserControl.Resources>

    <Grid Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Cabeçalho -->
        <Border Grid.Row="0"
                Style="{DynamicResource ViewHeaderStyle}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="{Binding Title}"
                           Style="{DynamicResource Title1Style}" />

                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right">
                    <Button Style="{StaticResource SecondaryButtonStyle}"
                            Command="{Binding CancelarCommand}"
                            VerticalAlignment="Center"
                            Margin="0,0,12,0"
                            IsEnabled="{Binding IsSaving, Converter={StaticResource InverseBooleanConverter}}">
                        <TextBlock Text="Cancelar" />
                    </Button>

                    <Button Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding SalvarAsyncCommand}"
                            IsEnabled="{Binding IsSaving, Converter={StaticResource InverseBooleanConverter}}"
                            VerticalAlignment="Center"
                            MinWidth="120">
                        <StackPanel Orientation="Horizontal">
                            <icon:PackIconMaterial Kind="ContentSave"
                                                   Width="16"
                                                   Height="16"
                                                   Margin="0,0,8,0"
                                                   Visibility="{Binding IsSaving, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                            <icon:PackIconMaterial Style="{DynamicResource LoadingIconStyle}"
                                                   Width="16"
                                                   Height="16"
                                                   Margin="0,0,8,0"
                                                   Visibility="{Binding IsSaving, Converter={StaticResource BoolToVisibilityConverter}}" />
                            <!-- Usando seu estilo limpo -->
                            <TextBlock Text="{Binding IsSaving, Converter={StaticResource BooleanToTextConverter}, ConverterParameter='Salvando...|Salvar'}" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Conteúdo Principal -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <!-- ESQUERDA: Tracker (Cronômetro/Métricas) -->
                <ColumnDefinition Width="340" />
                <!-- DIREITA: Contexto e Notas -->
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- COLUNA ESQUERDA: O TRACKER -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- CARD 1: CRONÔMETRO (Hero) -->
                <Border Grid.Row="0"
                        VerticalAlignment="Stretch"
                        Style="{DynamicResource PrimaryCardStyle}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <Grid Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0"
                                       Text="Sessão Atual"
                                       Style="{DynamicResource Title2Style}"
                                       Margin="0" />
                            <icon:PackIconMaterial Grid.Column="1"
                                                   Kind="TimerOutline"
                                                   HorizontalAlignment="Right"
                                                   Foreground="{DynamicResource PrimaryBrush}"
                                                   Width="20"
                                                   Height="20" />
                        </Grid>

                        <!-- Display do Tempo (Simulado para Layout) -->
                        <TextBlock Grid.Row="1"
                                   Text="{Binding DuracaoTexto, TargetNullValue='00:00:00'}"
                                   HorizontalAlignment="Center"
                                   FontSize="54"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   Margin="0,20" />

                        <!-- Controles do Cronômetro -->
                        <Grid Grid.Row="2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="1"
                                        Orientation="Horizontal">

                                <!-- Botão Play/Pause -->
                                <Button x:Name="PlayPauseButton"
                                        Style="{DynamicResource IconButtonStyle}"
                                        Width="48"
                                        Height="48"
                                        Background="{DynamicResource PrimaryBrush}"
                                        Command="{Binding AlternarTimerEMinimizarCommand}"
                                        ToolTip="{Binding IsTimerAtivo, Converter={StaticResource BooleanToTextConverter}, ConverterParameter='Pausar|Iniciar'}">
                                    <icon:PackIconMaterial Width="24"
                                                           Height="24"
                                                           Foreground="White"
                                                           Kind="{Binding IsTimerAtivo, Converter={StaticResource BooleanToTextConverter}, ConverterParameter='Pause|Play'}" />
                                </Button>

                                <!-- Botão Reset -->
                                <Button Style="{DynamicResource IconButtonStyle}"
                                        HorizontalAlignment="Center"
                                        Margin="10,0,0,0"
                                        Command="{Binding ReiniciarTimerCommand}"
                                        ToolTip="Zerar">
                                    <icon:PackIconMaterial Kind="Restore"
                                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                </Button>
                            </StackPanel>

                        </Grid>

                        <Separator Grid.Row="3"
                                   Background="{DynamicResource BorderBrush}"
                                   Margin="0,15,0,15" />

                        <!-- Edição Manual (Fallback) -->
                        <TextBox Grid.Row="4"
                                 Text="{Binding DuracaoTexto, TargetNullValue='00:00:00', UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource DurationTextBoxStyle}"
                                 HorizontalAlignment="Stretch"
                                 Margin="0"
                                 Tag="Ajuste Manual"
                                 HorizontalContentAlignment="Center">
                            <i:Interaction.Behaviors>
                                <behaviors:DurationValidationBehavior />
                            </i:Interaction.Behaviors>

                        </TextBox>

                        <!-- Checkbox para minimizar janela para a bandeja -->
                        <CheckBox Grid.Row="5"
                                  Content="Minimizar para a bandeja ao iniciar"
                                  IsChecked="{Binding MinimizarParaBandeja, Mode=TwoWay}"
                                  Style="{DynamicResource RoundedCheckBoxStyle}"
                                  HorizontalAlignment="Left"
                                  Margin="0,6,0,0" />
                        
                        <!-- Checkbox para ativar pomodoro -->
                        <CheckBox Grid.Row="6"
                                  Content="Usar pomodoro"
                                  IsChecked="{Binding UsarPomodoro, Mode=TwoWay}"
                                  Style="{DynamicResource RoundedCheckBoxStyle}"
                                  HorizontalAlignment="Left"
                                  Margin="0,6,0,0" />
                    </Grid>
                </Border>

                <!-- CARD 2: REVISÃO -->
                <Border Grid.Row="1"
                        VerticalAlignment="Stretch"
                        Style="{DynamicResource PrimaryCardStyle}"
                        Margin="20,20,20,20">

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0"
                                   Style="{DynamicResource Title2Style}"
                                   Margin="0,0,0,8"
                                   Text="Agendar Revisão" />



                        <ComboBox Grid.Row="1"
                                  ItemsSource="{Binding TiposRevisao}"
                                  SelectedItem="{Binding TipoRevisaoSelecionado}"
                                  DisplayMemberPath="Nome"
                                  Style="{DynamicResource ModernComboBoxStyle}"
                                  Tag="Tipo de Revisão" />


                        <ScrollViewer  Grid.Row="2"
                                       VerticalScrollBarVisibility="Visible"
                                       HorizontalScrollBarVisibility="Disabled"
                                       Margin="0"
                                       Style="{DynamicResource ModernScrollViewerStyle}">

                            <StackPanel>
                                <TextBlock Style="{DynamicResource Text1Style}"
                                           HorizontalAlignment="Left"
                                           TextWrapping="Wrap"
                                           Text="{Binding TipoRevisaoSelecionado.Descricao}" />
                            </StackPanel>
                        </ScrollViewer>

                    </Grid>
                </Border>

            </Grid>

            <!-- COLUNA DIREITA: CONTEXTO E NOTAS -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- CARD SUPERIOR: CONTEXTO DO ESTUDO -->
                <Border Grid.Row="0"
                        Style="{DynamicResource PrimaryCardStyle}"
                        Margin="0,20,20,20">

                    <!-- Lado Esquerdo: O Quê -->
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="Estudo"
                                   Style="{DynamicResource Title2Style}"
                                   Margin="0,0,0,10" />

                        <ComboBox ItemsSource="{Binding Disciplinas}"
                                  SelectedItem="{Binding DisciplinaSelecionada}"
                                  DisplayMemberPath="Nome"
                                  Style="{DynamicResource ModernComboBoxStyle}"
                                  Margin="0"
                                  Tag="Disciplina"
                                  IsEnabled="{Binding IsRevisao, Converter={StaticResource InverseBooleanConverter}}" />

                        <Grid Margin="0,8,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <ComboBox Grid.Column="0"
                                      ItemsSource="{Binding Assuntos}"
                                      SelectedItem="{Binding AssuntoSelecionado}"
                                      DisplayMemberPath="Nome"
                                      Style="{DynamicResource ModernComboBoxStyle}"
                                      Margin="0"
                                      Tag="Assunto"
                                      IsEnabled="{Binding IsRevisao, Converter={StaticResource InverseBooleanConverter}}" />

                            <Button Grid.Column="1"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{Binding AbrirCadernoQuestoesCommand}"
                                    Margin="8,0,0,0"
                                    Padding="0"
                                    ToolTip="Abrir Caderno de Questões"
                                    Width="36"
                                    Height="36">
                                <Button.IsEnabled>
                                    <MultiBinding Converter="{StaticResource StringToBooleanConverter}">
                                        <Binding Path="AssuntoSelecionado.CadernoQuestoes" />
                                        <Binding Path="AssuntoSelecionado.CadernoQuestoes" />
                                    </MultiBinding>
                                </Button.IsEnabled>
                                <icon:PackIconMaterial Kind="Earth"
                                                       Width="16"
                                                       Height="16" />
                            </Button>
                        </Grid>

                        <Grid Margin="0,5,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <TextBox Grid.Column="0"
                                     Text="{Binding Material}"
                                     Style="{DynamicResource ModernTextBoxWithPlaceholderStyle}"
                                     Tag="Material"
                                     Margin="0,0,5,0" />

                            <TextBox Grid.Column="1"
                                     Text="{Binding Professor}"
                                     Style="{DynamicResource ModernTextBoxWithPlaceholderStyle}"
                                     Tag="Professor"
                                     Margin="0,0,5,0" />

                            <ComboBox Grid.Column="2"
                                      ItemsSource="{Binding TiposEstudo}"
                                      SelectedItem="{Binding TipoEstudoSelecionado}"
                                      DisplayMemberPath="Nome"
                                      Style="{DynamicResource ModernComboBoxStyle}"
                                      Tag="Tipo"
                                      Margin="0,0,5,0"
                                      IsEnabled="{Binding IsRevisao, Converter={StaticResource InverseBooleanConverter}}" />

                            <DatePicker Grid.Column="3"
                                        SelectedDate="{Binding DataEstudo}"
                                        Style="{StaticResource ModernDatePickerStyle}"
                                        Tag="Data"
                                        Margin="0"
                                        IsEnabled="{Binding IsRevisao, Converter={StaticResource InverseBooleanConverter}}" />

                        </Grid>

                        <Grid Margin="0,5,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <TextBox Grid.Column="0"
                                     Text="{Binding Acertos}"
                                     Style="{DynamicResource ModernTextBoxWithPlaceholderStyle}"
                                     Tag="Acertos"
                                     Margin="0,0,5,0" />

                            <TextBox Grid.Column="1"
                                     Text="{Binding Erros}"
                                     Style="{DynamicResource ModernTextBoxWithPlaceholderStyle}"
                                     Tag="Erros"
                                     Margin="0,0,5,0" />

                            <TextBox Grid.Column="2"
                                     Text="{Binding PaginaInicial}"
                                     Style="{DynamicResource ModernTextBoxWithPlaceholderStyle}"
                                     Tag="Página Inicial"
                                     Margin="0,0,5,0" />

                            <TextBox Grid.Column="3"
                                     Text="{Binding PaginaFinal}"
                                     Style="{DynamicResource ModernTextBoxWithPlaceholderStyle}"
                                     Tag="Página Final"
                                     Margin="0" />
                        </Grid>

                        <Border Style="{DynamicResource SecondaryCardStyle}"
                                Margin="0,0,0,8">

                            <StackPanel Orientation="Horizontal">

                                <!-- Total de Questões -->
                                <StackPanel Orientation="Horizontal"
                                            VerticalAlignment="Center"
                                            ToolTip="Total de Questões"
                                            Margin="0,0,24,0">
                                    <icon:PackIconMaterial Style="{DynamicResource QuestoesIconStyle}" />
                                    <TextBlock Text="{Binding TotalQuestoes, StringFormat='{}{0}'}"
                                               Style="{DynamicResource QuestoesTextStyle}" />
                                </StackPanel>

                                <!-- Rendimento -->
                                <StackPanel Orientation="Horizontal"
                                            VerticalAlignment="Center"
                                            ToolTip="Rendimento"
                                            Margin="0,0,24,0">
                                    <icon:PackIconMaterial Style="{DynamicResource RendimentoIconStyle}" />
                                    <TextBlock Text="{Binding RendimentoPercentual, StringFormat='{}{0:F2}%'}"
                                               Style="{DynamicResource RendimentoTextStyle}" />
                                </StackPanel>

                                <!-- Total de Páginas -->
                                <StackPanel Orientation="Horizontal"
                                            VerticalAlignment="Center"
                                            ToolTip="Total de Páginas Lidas"
                                            Margin="0,0,24,0">
                                    <icon:PackIconMaterial Style="{DynamicResource PaginasLidasIconStyle}" />
                                    <TextBlock Text="{Binding TotalPaginas, StringFormat='{}{0}'}"
                                               Style="{DynamicResource PaginasLidasTextStyle}" />
                                </StackPanel>

                                <!-- Ritmo de Leitura -->
                                <StackPanel Orientation="Horizontal"
                                            VerticalAlignment="Center"
                                            ToolTip="Ritmo de Leitura"
                                            Margin="0,0,24,0">
                                    <icon:PackIconMaterial Style="{DynamicResource HorasEstudadasIconStyle}" />
                                    <TextBlock Text="{Binding RitmoPaginas, StringFormat='{}{0:N2}'}"
                                               Style="{DynamicResource HorasEstudadasTextStyle}" />
                                </StackPanel>

                                <!-- Páginas por Minuto -->
                                <StackPanel Orientation="Horizontal"
                                            VerticalAlignment="Center"
                                            ToolTip="Páginas por Minuto"
                                            Margin="0,0,24,0">
                                    <icon:PackIconMaterial Style="{DynamicResource PaginasLidasIconStyle}" />
                                    <TextBlock Text="{Binding PaginasPorMinuto, StringFormat='{}{0:N2}'}"
                                               Style="{DynamicResource PaginasLidasTextStyle}" />
                                </StackPanel>

                                <!-- Ritmo de Questões -->
                                <StackPanel Orientation="Horizontal"
                                            VerticalAlignment="Center"
                                            ToolTip="Ritmo de Questões"
                                            Margin="0,0,24,0">
                                    <icon:PackIconMaterial Style="{DynamicResource HorasEstudadasIconStyle}" />
                                    <TextBlock Text="{Binding RitmoQuestoes, StringFormat='{}{0:N2}'}"
                                               Style="{DynamicResource HorasEstudadasTextStyle}" />
                                </StackPanel>

                                <!-- Questões por Minuto -->
                                <StackPanel Orientation="Horizontal"
                                            VerticalAlignment="Center"
                                            ToolTip="Questões por Minuto"
                                            Margin="0,0,24,0">
                                    <icon:PackIconMaterial Style="{DynamicResource QuestoesIconStyle}" />
                                    <TextBlock Text="{Binding QuestoesPorMinuto, StringFormat='{}{0:N2}'}"
                                               Style="{DynamicResource QuestoesTextStyle}" />
                                </StackPanel>

                            </StackPanel>
                        </Border>

                        <!-- Checkbox para marcar assunto como concluído -->
                        <CheckBox Content="Assunto concluído"
                                  IsChecked="{Binding MarcarAssuntoConcluido, Mode=TwoWay}"
                                  Style="{DynamicResource RoundedCheckBoxStyle}"
                                  HorizontalAlignment="Left"
                                  Margin="0,6,0,0" />
                    </StackPanel>
                </Border>

                <!-- CARD INFERIOR: CADERNO DE NOTAS (Expandível) -->
                <Border Grid.Row="1"
                        Style="{DynamicResource PrimaryCardStyle}"
                        Margin="0,0,20,20">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="1.5*" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <TextBox Grid.Row="0"
                                 Text="{Binding Topicos}"
                                 Style="{DynamicResource ModernTextBoxWithPlaceholderStyle}"
                                 Tag="Tópicos"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Auto"
                                 VerticalContentAlignment="Top"
                                 Margin="0,0,0,20" />

                        <TextBox Grid.Row="1"
                                 Text="{Binding Comentarios}"
                                 Style="{DynamicResource ModernTextBoxWithPlaceholderStyle}"
                                 Tag="Comentários"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Auto"
                                 VerticalContentAlignment="Top" />
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>